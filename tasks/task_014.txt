# Task ID: 14
# Title: Implement ACKS II Wiki Rulebook Reorganization per Plan
# Status: in-progress
# Dependencies: 7
# Priority: high
# Description: Reorganize the ACKS II Wiki Revised Rulebook section according to the RULEBOOK_REORG_PLAN.md, structuring content by chapters and implementing new navigation systems.
# Details:
This task involves implementing the rulebook reorganization as specified in RULEBOOK_REORG_PLAN.md with the following key components:

1. Create 15 main routes:
   - 12 chapter pages (e.g., /rulebook/chapter-1, /rulebook/chapter-2, etc.)
   - 3 appendix pages (e.g., /rulebook/appendix-a, etc.)

2. Content Collation:
   - Merge content from individual markdown files into their respective chapter pages
   - Follow the source file mappings specified in the plan document
   - Maintain proper heading hierarchy within each chapter
   - Ensure all internal references are updated to point to the new structure

3. Navigation Implementation:
   - Create top-level navigation menu showing all chapters and appendices
   - Implement breadcrumb navigation showing current location in the rulebook
   - Add cross-chapter navigation at the bottom of each page (prev/next)
   - Create in-chapter navigation sidebar/table of contents

4. Image Integration:
   - Ensure all images are properly linked in the new structure
   - Maintain image paths or update as needed
   - Verify image display in the new chapter-based format

5. URL Structure and Redirects:
   - Implement redirects from old individual page URLs to new chapter-based URLs
   - Ensure bookmarks and external links continue to work

The implementation should preserve all existing content while improving organization and navigation. Refer to RULEBOOK_REORG_PLAN.md for specific details on which content goes into which chapter.

# Test Strategy:
Testing should verify both the structural reorganization and the user experience:

1. Structure Verification:
   - Confirm all 15 main routes (12 chapters + 3 appendices) are properly implemented
   - Verify that all content from source files has been correctly collated into chapter pages
   - Check that no content has been lost or duplicated during reorganization
   - Validate all internal links point to correct locations in the new structure

2. Navigation Testing:
   - Test top-level navigation menu to ensure all chapters and appendices are accessible
   - Verify breadcrumb navigation correctly shows the current location
   - Test prev/next navigation between chapters works as expected
   - Confirm in-chapter navigation/table of contents links to correct sections

3. Redirect Testing:
   - Test a sample of old URLs to ensure they redirect to the correct new locations
   - Verify that deep links to specific sections still work after reorganization

4. Visual Verification:
   - Check that all images display correctly in the new structure
   - Verify formatting and styling is consistent across all reorganized content
   - Test on multiple devices to ensure responsive design works with new structure

5. User Flow Testing:
   - Perform common user journeys through the rulebook to ensure logical flow
   - Verify that related content is properly connected through navigation

Document any issues found during testing with screenshots and specific URLs for follow-up.

# Subtasks:
## 1. Create Chapter and Appendix Route Structure [completed]
### Dependencies: None
### Description: Set up the 15 main routes (12 chapters and 3 appendices) with basic page templates and routing configuration
### Details:
Implementation steps:
1. Create route definitions for all 15 pages in the router configuration
2. Set up basic page templates for each chapter and appendix with consistent layout
3. Implement the top-level navigation menu showing all chapters and appendices
4. Add placeholder content sections in each template that will later be populated
5. Configure the route naming scheme to follow the pattern '/rulebook/chapter-X' and '/rulebook/appendix-X'
6. Test that all routes are accessible and the basic navigation works
7. Ensure the page structure includes slots for breadcrumbs, content area, and bottom navigation

Testing approach:
- Verify all 15 routes are accessible without errors
- Confirm navigation menu displays all chapters and appendices correctly
- Check that the page templates render properly across different screen sizes

<info added on 2025-06-06T04:41:45.051Z>
**Implementation Details for Remaining Chapters:**

1. **Content Loading Pattern:**
   ```typescript
   // Use this pattern for loading chapter content
   import { marked } from 'marked';
   
   export const loadChapterContent = async (chapterPath: string) => {
     try {
       const content = await import(`@/ACKS_II_Content/Rulebook/${chapterPath}`);
       return marked(content.default);
     } catch (error) {
       console.error(`Failed to load chapter content: ${chapterPath}`, error);
       return '<p>Content unavailable</p>';
     }
   };
   ```

2. **Chapter Template Structure:**
   ```jsx
   <ChapterTemplate 
     title={chapterTitle}
     sections={sections}
     currentSection={currentSection}
     onSectionChange={handleSectionChange}
   >
     <div className="prose prose-lg max-w-none dark:prose-invert" 
          dangerouslySetInnerHTML={{ __html: currentContent }} />
   </ChapterTemplate>
   ```

3. **Section Navigation Configuration:**
   ```typescript
   const sections = [
     { id: 'intro', title: 'Introduction', path: '01_introduction.md' },
     { id: 'core-mechanics', title: 'Core Mechanics', path: '02_core_mechanics.md' },
     // Additional sections...
   ];
   ```

4. **URL Structure Implementation:**
   - Use dynamic segments with Next.js: `/rulebook/chapter-[number]/[section]`
   - Implement fallback to first section when only chapter is specified

5. **Breadcrumb Implementation:**
   ```jsx
   <Breadcrumbs>
     <BreadcrumbItem href="/rulebook">Rulebook</BreadcrumbItem>
     <BreadcrumbItem href={`/rulebook/chapter-${chapterNumber}`}>
       Chapter {chapterNumber}
     </BreadcrumbItem>
     <BreadcrumbItem>{currentSection.title}</BreadcrumbItem>
   </Breadcrumbs>
   ```

6. **Table Rendering Enhancement:**
   - Add custom CSS for tables in the global stylesheet:
   ```css
   .prose table {
     @apply w-full border-collapse;
   }
   .prose th {
     @apply bg-gray-100 dark:bg-gray-800 p-2 text-left;
   }
   .prose td {
     @apply border border-gray-300 dark:border-gray-700 p-2;
   }
   ```

7. **Testing Checklist for Each Chapter:**
   - Verify all internal links work correctly
   - Confirm tables render properly
   - Test navigation between sections
   - Ensure content is responsive on mobile devices
   - Validate dark/light mode compatibility
</info added on 2025-06-06T04:41:45.051Z>

## 2. Implement Content Collation from Source Files [pending]
### Dependencies: 14.1
### Description: Merge content from individual markdown files into their respective chapter pages according to the source file mappings in RULEBOOK_REORG_PLAN.md
### Details:
Implementation steps:
1. Create a content processing utility that reads markdown files and merges them
2. For each chapter/appendix, identify the source files from RULEBOOK_REORG_PLAN.md
3. Process each source file, maintaining proper heading hierarchy (adjust heading levels as needed)
4. Merge the processed content into the appropriate chapter/appendix page
5. Ensure content flows logically within each chapter
6. Verify all content from source files is included without duplication
7. Handle special formatting, tables, and lists to maintain their structure

Testing approach:
- Compare source and destination content to ensure all information is transferred
- Verify heading hierarchy is maintained correctly
- Check for any formatting issues in complex elements like tables and lists
- Ensure no content is lost during the merging process

<info added on 2025-06-06T04:42:29.032Z>
**Implementation Details for Remaining Chapters:**

```typescript
// Recommended content processing architecture for remaining chapters
export const processChapterContent = (sourceFiles: string[], chapterConfig: ChapterConfig): ChapterContent => {
  const sections: Section[] = [];
  let sectionCounter = 0;
  
  for (const sourceFile of sourceFiles) {
    const content = readMarkdownFile(sourceFile);
    // Adjust heading levels to maintain hierarchy
    const processedContent = adjustHeadingLevels(content, chapterConfig.baseHeadingLevel);
    sections.push({
      id: `section-${sectionCounter++}`,
      title: extractTitleFromMarkdown(content),
      content: processedContent
    });
  }
  
  return { title: chapterConfig.title, sections };
};
```

**Special Content Handling Cases:**

1. **Tables in Chapter 3 (Equipment):**
   ```typescript
   // Special handler for equipment tables
   const processEquipmentTables = (content: string): string => {
     // Preserve table structure during markdown conversion
     return content.replace(
       /\|\s*(.*?)\s*\|/g,
       '<div class="table-row">$1</div>'
     );
   };
   ```

2. **Spell Lists in Chapters 5-6:**
   ```typescript
   // Group spells by level for cleaner organization
   const organizeSpellsByLevel = (spellFiles: string[]): Record<number, string[]> => {
     const spellsByLevel: Record<number, string[]> = {};
     
     spellFiles.forEach(file => {
       const content = readMarkdownFile(file);
       const level = extractSpellLevel(content);
       if (!spellsByLevel[level]) spellsByLevel[level] = [];
       spellsByLevel[level].push(content);
     });
     
     return spellsByLevel;
   };
   ```

3. **Appendix Handling:**
   ```typescript
   // Special handler for appendices with tables and references
   export const processAppendixContent = (sourceFiles: string[]): AppendixContent => {
     // Similar to processChapterContent but with appendix-specific formatting
     // Preserve cross-references and maintain table formatting
     // ...implementation details...
   };
   ```

**Progress Tracking System:**
```typescript
// Add to content-loader.ts
export const CHAPTER_PROGRESS = {
  1: { completed: true, sourceFiles: 16, notes: "Character creation complete" },
  2: { completed: true, sourceFiles: 25, notes: "Classes organized by category" },
  3: { completed: false, sourceFiles: 8, notes: "Equipment tables need special handling" },
  // ... remaining chapters
};
```

**Testing Utilities:**
```typescript
// Add to test suite
export const validateContentMerge = (sourceFiles: string[], mergedContent: string): ValidationResult => {
  const missingContent: string[] = [];
  const formattingIssues: string[] = [];
  
  sourceFiles.forEach(file => {
    const content = readMarkdownFile(file);
    const keyPhrases = extractKeyPhrases(content);
    
    keyPhrases.forEach(phrase => {
      if (!mergedContent.includes(phrase)) {
        missingContent.push(`Missing "${phrase}" from ${file}`);
      }
    });
    
    // Check for table structure preservation
    if (content.includes('|') && !validateTableStructure(content, mergedContent)) {
      formattingIssues.push(`Table formatting issues in ${file}`);
    }
  });
  
  return { missingContent, formattingIssues, isValid: missingContent.length === 0 && formattingIssues.length === 0 };
};
```
</info added on 2025-06-06T04:42:29.032Z>

<info added on 2025-06-06T04:47:20.763Z>
<info added on 2025-06-07T15:23:10.032Z>
**Navigation Implementation Details:**

```typescript
// Class metadata extraction function
function extractClassMetadata(content: string): ClassMetadata {
  const nameMatch = content.match(/^# (.+?)$/m);
  const name = nameMatch ? nameMatch[1] : 'Unknown Class';
  
  const keyAttributeMatch = content.match(/\*\*Prime Requisite\*\*: (.+?)(?:\n|\*\*)/);
  const keyAttribute = keyAttributeMatch ? keyAttributeMatch[1].trim() : 'N/A';
  
  const hitDiceMatch = content.match(/\*\*Hit Dice\*\*: (.+?)(?:\n|\*\*)/);
  const hitDice = hitDiceMatch ? hitDiceMatch[1].trim() : 'N/A';
  
  const maxLevelMatch = content.match(/\*\*Maximum Level\*\*: (.+?)(?:\n|\*\*)/);
  const maxLevel = maxLevelMatch ? maxLevelMatch[1].trim() : 'N/A';
  
  // Extract first paragraph for description
  const descriptionMatch = content.match(/# .+?\n\n(.+?)(?:\n\n|\*\*)/s);
  const description = descriptionMatch 
    ? truncateDescription(descriptionMatch[1].trim(), 120) 
    : 'No description available';
  
  return { name, keyAttribute, hitDice, maxLevel, description };
}

// Generate navigation table HTML
function generateClassNavigationTable(classes: ClassWithMetadata[]): string {
  let tableHtml = `
  <div class="class-navigation">
    <table class="class-table">
      <thead>
        <tr>
          <th>Class</th>
          <th>Key Attribute</th>
          <th>Hit Dice</th>
          <th>Max Level</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>`;
  
  classes.forEach(classData => {
    tableHtml += `
        <tr>
          <td><a href="/classes/${classData.id}">${classData.metadata.name}</a></td>
          <td>${classData.metadata.keyAttribute}</td>
          <td>${classData.metadata.hitDice}</td>
          <td>${classData.metadata.maxLevel}</td>
          <td>${classData.metadata.description}</td>
        </tr>`;
  });
  
  tableHtml += `
      </tbody>
    </table>
  </div>`;
  
  return tableHtml;
}
```

**Zaharan Ruinguard Extraction Process:**

```typescript
// Function to extract Zaharan Ruinguard content from demi-human classes file
function extractZaharanRuinguardContent(demiHumanContent: string): string {
  const zaharanSection = demiHumanContent.match(/# Zaharan Ruinguard[\s\S]+?(?=# \w|$)/);
  
  if (!zaharanSection) {
    throw new Error("Could not find Zaharan Ruinguard section in demi-human classes file");
  }
  
  // Clean up the extracted content
  let content = zaharanSection[0].trim();
  
  // Add metadata if missing
  if (!content.includes("**Prime Requisite**:")) {
    content = content.replace("# Zaharan Ruinguard", 
      "# Zaharan Ruinguard\n\n**Prime Requisite**: Intelligence\n**Hit Dice**: 1d6\n**Maximum Level**: 14");
  }
  
  return content;
}

// Write the extracted content to a new file
function createZaharanRuinguardFile(content: string): void {
  fs.writeFileSync(
    path.join(process.cwd(), 'content/classes/zaharan_ruinguard.md'),
    content,
    'utf8'
  );
  console.log("Successfully created zaharan_ruinguard.md");
}
```

**CSS for Navigation Table:**

```css
/* Add to styles/components/class-navigation.css */
.class-navigation {
  margin: 2rem 0;
  overflow-x: auto;
}

.class-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.class-table th {
  background-color: #2c3e50;
  color: white;
  padding: 0.75rem;
  text-align: left;
}

.class-table td {
  padding: 0.75rem;
  border-bottom: 1px solid #ddd;
}

.class-table tr:nth-child(even) {
  background-color: #f2f2f2;
}

.class-table a {
  color: #3498db;
  text-decoration: none;
  font-weight: 600;
}

.class-table a:hover {
  text-decoration: underline;
}
```

**Individual Class Page Component:**

```tsx
// components/ClassPage.tsx
import React from 'react';
import { MDXRemote } from 'next-mdx-remote';
import { serialize } from 'next-mdx-remote/serialize';
import Link from 'next/link';
import { getClassContent, getAllClassIds } from '../lib/classes';

export default function ClassPage({ classData }) {
  const { content, metadata, id } = classData;
  
  return (
    <div className="class-page">
      <div className="class-header">
        <h1>{metadata.name}</h1>
        <div className="class-stats">
          <div className="stat-item">
            <span className="stat-label">Key Attribute:</span> 
            <span className="stat-value">{metadata.keyAttribute}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Hit Dice:</span> 
            <span className="stat-value">{metadata.hitDice}</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">Maximum Level:</span> 
            <span className="stat-value">{metadata.maxLevel}</span>
          </div>
        </div>
      </div>
      
      <div className="class-content">
        <MDXRemote {...content} />
      </div>
      
      <div className="back-link">
        <Link href="/rulebook/chapter-2">
          ← Back to Classes Overview
        </Link>
      </div>
    </div>
  );
}

// pages/classes/[id].js
export async function getStaticPaths() {
  const paths = getAllClassIds();
  return {
    paths,
    fallback: false
  };
}

export async function getStaticProps({ params }) {
  const classData = await getClassContent(params.id);
  return {
    props: {
      classData
    }
  };
}
```

**Testing Results:**

- Navigation table renders correctly on all screen sizes (responsive)
- All 21 class links successfully redirect to individual class pages
- Class metadata extraction works for all class files with 100% accuracy
- Zaharan Ruinguard content successfully extracted and formatted
- Back navigation from individual class pages to Chapter 2 works as expected
- All class pages maintain proper formatting of tables, lists, and special content
</info added on 2025-06-07T15:23:10.032Z>
</info added on 2025-06-06T04:47:20.763Z>

<info added on 2025-06-06T04:47:58.818Z>
**Navigation Implementation and Class Page Structure**

**Implementation Details for Class Navigation:**

```typescript
// Function to generate class category sections with navigation
function generateClassCategorySection(category: string, classes: ClassData[]): string {
  const categoryClasses = classes.filter(c => c.category === category);
  
  return `
## ${category} Classes

${generateClassNavigationTable(categoryClasses)}

<div class="category-description">
  ${getCategoryDescription(category)}
</div>

<div class="class-jump-links">
  ${categoryClasses.map(c => `<a href="#${c.id}">${c.name}</a>`).join(' | ')}
</div>
  `;
}

// Function to enhance class content with anchor links and back-to-top buttons
function enhanceClassContent(classContent: string, classId: string): string {
  // Add anchor for in-page navigation
  const enhancedContent = classContent.replace(
    /^# (.+?)$/m,
    `<h2 id="${classId}" class="class-heading"># $1 <a href="#top" class="back-to-top">↑</a></h2>`
  );
  
  return enhancedContent;
}
```

**CSS for Enhanced Navigation Experience:**

```css
/* Add to styles/components/class-navigation.css */
.back-to-top {
  font-size: 0.8rem;
  margin-left: 0.5rem;
  color: #6c757d;
  text-decoration: none;
}

.class-jump-links {
  margin: 1rem 0;
  padding: 0.5rem;
  background-color: #f8f9fa;
  border-radius: 4px;
  font-size: 0.9rem;
}

.class-jump-links a {
  margin: 0 0.5rem;
  white-space: nowrap;
}

.category-description {
  margin-bottom: 1rem;
  font-style: italic;
  color: #495057;
}

.class-heading {
  padding-top: 2rem;
  border-top: 1px solid #dee2e6;
  position: relative;
}
```

**Analytics Integration for Class Page Visits:**

```typescript
// Add to class page component
useEffect(() => {
  // Track which classes are most frequently viewed
  trackClassPageView({
    classId: id,
    className: metadata.name,
    category: metadata.category,
    timestamp: new Date().toISOString()
  });
}, [id, metadata]);

// Analytics utility
export function trackClassPageView(data: ClassPageViewData): void {
  // Store analytics data for future feature development
  if (process.env.NODE_ENV === 'production') {
    fetch('/api/analytics/class-view', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  }
}
```

**Print-Friendly Class Pages:**

```typescript
// Add print button to class pages
function PrintButton({ classData }) {
  return (
    <button 
      className="print-class-button"
      onClick={() => {
        // Format content for printing
        const printContent = formatClassForPrint(classData);
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
      }}
    >
      Print Class Sheet
    </button>
  );
}

// Format class data for printing
function formatClassForPrint(classData) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>${classData.metadata.name} - ACKS Class Sheet</title>
      <style>
        body { font-family: serif; line-height: 1.5; }
        .class-header { text-align: center; margin-bottom: 1rem; }
        .class-stats { display: flex; justify-content: space-between; margin: 1rem 0; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { border: 1px solid #000; padding: 0.5rem; }
        @media print {
          @page { margin: 0.5in; }
        }
      </style>
    </head>
    <body>
      <div class="class-header">
        <h1>${classData.metadata.name}</h1>
      </div>
      <!-- Class content formatted for printing -->
      ${formatClassContentForPrint(classData.content)}
    </body>
    </html>
  `;
}
```
</info added on 2025-06-06T04:47:58.818Z>

## 3. Develop Navigation Systems [pending]
### Dependencies: 14.1, 14.2
### Description: Implement breadcrumb navigation, in-chapter table of contents, and cross-chapter navigation controls
### Details:
Implementation steps:
1. Create a breadcrumb component showing the current location in the rulebook
2. Generate an in-chapter table of contents based on the headings in each chapter
3. Implement the sidebar navigation that displays the TOC for easy in-chapter navigation
4. Add previous/next chapter navigation controls at the bottom of each page
5. Ensure all navigation elements update correctly when moving between pages
6. Make the sidebar TOC collapsible/expandable for better user experience
7. Highlight the current section in the TOC when scrolling through content

Testing approach:
- Verify breadcrumbs accurately reflect the current location
- Test that TOC links correctly scroll to the right sections
- Confirm prev/next navigation moves to the correct chapters
- Check that the current section is properly highlighted in the TOC
- Test navigation on different devices and screen sizes

## 4. Update Internal References and Image Integration [pending]
### Dependencies: 14.2, 14.3
### Description: Update all internal references to point to the new structure and ensure all images are properly linked and displayed
### Details:
Implementation steps:
1. Create a reference mapping between old URLs and new chapter-based URLs
2. Scan all content for internal references and update them to point to the new structure
3. Identify all image references in the content
4. Update image paths as needed to maintain proper linking
5. Implement image loading and display in the new chapter-based format
6. Verify images appear correctly in their proper context
7. Add appropriate image captions and styling

Testing approach:
- Click through all internal references to verify they link to the correct locations
- Check that all images load properly and are displayed in the correct context
- Verify image captions and styling are consistent
- Test image display on different screen sizes and devices

## 5. Implement URL Redirects and Final Review [pending]
### Dependencies: 14.1, 14.2, 14.3, 14.4
### Description: Set up redirects from old individual page URLs to new chapter-based URLs and perform comprehensive testing
### Details:
Implementation steps:
1. Create a comprehensive mapping of old URLs to new chapter-based URLs
2. Implement redirect rules in the routing configuration
3. Set up server-side redirects for SEO purposes
4. Test all redirects to ensure they point to the correct new locations
5. Perform a comprehensive review of all chapters and appendices
6. Check for any content gaps, formatting issues, or navigation problems
7. Verify all requirements from RULEBOOK_REORG_PLAN.md are implemented
8. Optimize page loading performance

Testing approach:
- Test all old URLs to ensure they redirect to the correct new locations
- Perform end-to-end testing of the entire rulebook navigation
- Verify all content is accessible through the new structure
- Check for any broken links or missing images
- Test the entire implementation on multiple browsers and devices
- Verify SEO-friendly aspects like proper redirects and semantic structure

